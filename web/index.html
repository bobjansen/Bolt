<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMIX Playground</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="container">
        <header>
            <h1>MMIX Playground</h1>
            <p class="subtitle">Write, assemble, and run MMIX assembly code in your browser</p>
        </header>

        <div id="main-content">
            <div id="editor-section">
                <div id="toolbar">
                    <button id="assemble-run-btn" class="btn btn-primary">Assemble &amp; Run</button>
                    <button id="assemble-btn" class="btn btn-secondary">Assemble</button>
                    <button id="run-btn" class="btn btn-success" disabled>Run</button>
                    <span class="toolbar-separator"></span>
                    <button id="args-btn" class="btn btn-secondary">Args</button>
                    <button id="files-btn" class="btn btn-secondary">Files</button>
                    <input type="file" id="import-file-input" accept=".mms,.mmixal" style="display: none;">
                    <input type="file" id="upload-data-file-input" style="display: none;">
                </div>
                <div id="args-display">
                    <label>Args:</label>
                    <input type="text" id="args-display-value" readonly>
                    <button id="edit-args-btn" class="btn btn-secondary">Edit</button>
                </div>
                <script>
                    // Immediately set args display state to prevent content jump
                    (function() {
                        const argsDisplay = document.getElementById('args-display');
                        const savedArgs = localStorage.getItem('mmix.currentArgs');
                        if (savedArgs && savedArgs.trim()) {
                            argsDisplay.style.display = 'flex';
                        } else {
                            argsDisplay.style.display = 'none';
                        }
                    })();
                </script>
                <textarea id="code-editor" spellcheck="false" placeholder="Enter MMIX assembly code here...

Example:
        LOC  #100
Main    GETA $255,String
        TRAP 0,Fputs,StdOut
        TRAP 0,Halt,0
String  BYTE &quot;Hello, World!&quot;,#a,0
"></textarea>
            </div>

            <div id="output-section">
                <div id="tabs">
                    <button class="tab active" data-tab="listing">Assembly Listing</button>
                    <button class="tab" data-tab="output">Simulation Output</button>
                    <button class="tab" data-tab="errors">Messages</button>
                </div>
                <pre id="listing-output" class="output-pane active"></pre>
                <pre id="simulation-output" class="output-pane"></pre>
                <pre id="error-output" class="output-pane"></pre>
            </div>
        </div>

        <footer>
            <p>MMIX Architecture by Donald E. Knuth â€” Web Playground powered by PyScript and Emscripten</p>
            <p><a href="https://github.com/bobjansen/Bolt" target="_blank" rel="noopener noreferrer">View on GitHub</a></p>
        </footer>
    </div>

    <!-- Example programs -->
    <script type="application/json" id="example-programs">
    {
        "hello": {
            "name": "Hello World",
            "code": "        LOC  #100\nMain    GETA $255,String\n        TRAP 0,Fputs,StdOut\n        TRAP 0,Halt,0\nString  BYTE \"Hello, World!\",#a,0\n"
        },
        "fibonacci": {
            "name": "Fibonacci Numbers",
            "code": "        LOC  Data_Segment\nBuffer  BYTE 0,0,0,0,0,0,0,0,0,0,0,0  % 12 byte buffer\nbuf     GREG @           % Global register with buffer address\n        LOC  #100\n% Print first 10 Fibonacci numbers\nfib0    GREG 0           % First Fibonacci number\nfib1    GREG 1           % Second Fibonacci number\ncount   GREG 10          % Counter\nMain    SET  fib0,0\n        SET  fib1,1\n        SET  count,10\nLoop    SET  $0,fib0     % Number to print\n        SET  $1,buf      % Buffer address from global register\n        SET  $2,11       % Position (end of buffer)\n        SET  $3,0        % Zero terminator\n        STB  $3,$1,$2    % Store zero byte\nDigit   SUB  $2,$2,1     % Move back\n        DIV  $0,$0,10    % Divide by 10\n        GET  $3,rR       % Get remainder\n        INCL $3,'0'      % Convert to ASCII\n        STB  $3,$1,$2    % Store digit\n        PBNZ $0,Digit    % Continue if not zero\n        ADDU $255,$1,$2  % Point to first digit\n        TRAP 0,Fputs,StdOut\n        GETA $255,NewLn\n        TRAP 0,Fputs,StdOut\n        ADD  $3,fib0,fib1 % Next = fib0 + fib1\n        SET  fib0,fib1   % Shift\n        SET  fib1,$3\n        SUB  count,count,1\n        BP   count,Loop\n        TRAP 0,Halt,0\nNewLn   BYTE #a,0\n"
        },
        "copy": {
            "name": "Copy Program",
            "code": "* SAMPLE PROGRAM: COPY A GIVEN FILE TO STANDARD OUTPUT\n\nt        IS   $255\nargc     IS   $0\nargv     IS   $1\ns        IS   $2\nBuf_Size IS   5                 ridiculously small for testing\n         LOC  Data_Segment\nBuffer   LOC  @+Buf_Size\n         GREG @\nArg0     OCTA 0,TextRead\nArg1     OCTA Buffer,Buf_Size\n      \n         LOC  #200              main(argc,argv) {\nMain     CMP  t,argc,2          if (argc==2) goto openit\n         PBZ  t,OpenIt\n         GETA t,1F              fputs(\"Usage: \",stderr)\n         TRAP 0,Fputs,StdErr\n         LDOU t,argv,0          fputs(argv[0],stderr)\n         TRAP 0,Fputs,StdErr\n         GETA t,2F              fputs(\" filename\\n\",stderr)\nQuit     TRAP 0,Fputs,StdErr    \n         NEG  t,0,1             quit: exit(-1)\n         TRAP 0,Halt,0\n1H       BYTE \"Usage: \",0\n         LOC  (@+3)&-4          align to tetrabyte\n2H       BYTE \" filename\",#a,0\n\nOpenIt   LDOU s,argv,8          openit: s=argv[1]\n         STOU s,Arg0\n         LDA  t,Arg0            fopen(argv[1],\"r\",file[3])\n         TRAP 0,Fopen,3\n         PBNN t,CopyIt          if (no error) goto copyit\n         GETA t,1F              fputs(\"Can't open file \",stderr)\n         TRAP 0,Fputs,StdErr\n         SET  t,s               fputs(argv[1],stderr)\n         TRAP 0,Fputs,StdErr\n         GETA t,2F              fputs(\"!\\n\",stderr)\n         JMP  Quit              goto quit\n1H       BYTE \"Can't open file \",0\n         LOC  (@+3)&-4          align to tetrabyte\n2H       BYTE \"!\",#a,0\n\nCopyIt   LDA  t,Arg1            copyit:\n         TRAP 0,Fread,3         items=fread(buffer,1,buf_size,file[3])\n         BN   t,EndIt           if (items < buf_size) goto endit\n         LDA  t,Arg1            items=fwrite(buffer,1,buf_size,stdout)\n         TRAP 0,Fwrite,StdOut\n         PBNN t,CopyIt          if (items >= buf_size) goto copyit\nTrouble  GETA t,1F              trouble: fputs(\"Trouble w...!\",stderr)\n         JMP  Quit              goto quit\n1H       BYTE \"Trouble writing StdOut!\",#a,0\n\nEndIt    INCL t,Buf_Size\n         BN   t,ReadErr         if (ferror(file[3])) goto readerr\n         STO  t,Arg1+8\n         LDA  t,Arg1            n=fwrite(buffer,1,items,stdout)\n         TRAP 0,Fwrite,StdOut\n         BN   t,Trouble         if (n < items) goto trouble\n         TRAP 0,Halt,0          exit(0)\nReadErr  GETA t,1F              readerr: fputs(\"Trouble r...!\",stderr)\n         JMP  Quit              goto quit }\n1H       BYTE \"Trouble reading!\",#a,0\n"
        }
    }
    </script>

    <!-- Files modal -->
    <div id="files-modal" class="modal">
        <div class="modal-content modal-large">
            <h2>Files</h2>

            <div id="file-tabs" class="file-tabs">
                <button class="file-tab active" data-tab="programs">Programs</button>
                <button class="file-tab" data-tab="examples">Examples</button>
                <button class="file-tab" data-tab="data">Data Files</button>
            </div>

            <div id="programs-pane" class="file-pane active">
                <div class="file-pane-header">
                    <label for="save-name-input">Save current program as:</label>
                    <div class="save-input-group">
                        <input type="text" id="save-name-input" placeholder="my-program">
                        <button id="save-confirm-btn" class="btn" style="margin-bottom: 20px">Save</button>
                    </div>
                </div>
                <div id="programs-list"></div>
                <div class="file-pane-footer">
                    <button id="import-btn" class="btn btn-secondary">Import .mms File</button>
                    <button id="export-btn" class="btn btn-secondary">Export Current</button>
                    <button id="files-close-btn" class="btn btn-secondary">Close</button>
                </div>
            </div>

            <div id="examples-pane" class="file-pane">
                <p>Example programs to get you started.</p>
                <div id="examples-list"></div>
            </div>

            <div id="data-pane" class="file-pane">
                <p>Upload data files that your MMIX programs can read (e.g., for the Copy example).</p>
                <div class="file-pane-header">
                    <button id="upload-file-btn" class="btn btn-primary">Upload File</button>
                </div>
                <div id="data-files-list"></div>
            </div>
        </div>
    </div>

    <!-- Args modal -->
    <div id="args-modal" class="modal">
        <div class="modal-content">
            <h2>Program Arguments</h2>
            <label for="args-input">Arguments (space-separated):</label>
            <input type="text" id="args-input" placeholder="e.g., filename.txt">
            <div class="modal-buttons">
                <button id="args-clear-btn" class="btn btn-secondary">Clear</button>
                <button id="args-assemble-run-btn" class="btn btn-primary">Assemble &amp; Run</button>
                <button id="args-done-btn" class="btn btn-secondary">Done</button>
            </div>
        </div>
    </div>

    <script type="py" src="mmix-playground.py?v=19" config="pyscript.toml"></script>
</body>
</html>
